import pandas as pd

file_path = 'products.csv'

def ultimate_sync():
    print("ğŸš€ æ­£åœ¨åŸ·è¡Œå…¨æ–¹ä½æ•¸æ“šæ ¡æº– (å«æ¨™é¡Œé‡å¯«)...")
    
    try:
        df = pd.read_csv(file_path, encoding='utf-8-sig')
        df.columns = [c.strip() for c in df.columns]

        # å®šç¾©æ ¸å¿ƒçŸ¥è­˜åº«
        # æ ¼å¼: é—œéµå­—: (æ­£ç¢ºæ¨™é¡Œ, åˆ†é¡æ¨™ç±¤, åƒ¹æ ¼, æ‘˜è¦, è©•åˆ†, å‹³ç« )
        kb = {
            "pizzahut": ("å¿…å‹å®¢ Pizza Hutï¼š2025 éš±è—å„ªæƒ ç¢¼å¯¦æ¸¬", "ç¾é£Ÿé¡", "ğŸ• è²·ä¸€é€ä¸€èµ·", "2025 å¿…å‹å®¢éš±è—å„ªæƒ ç¢¼ï¼šåŒ…å«å¤–å¸¶è²·ä¸€é€ä¸€ã€æ¯”è–©å¥—é¤æŠ˜åƒ¹åˆ¸å¯¦æ¸¬å¯ç”¨ã€‚", "4.6", "10è¬+ é£Ÿå®¢å¥½è©•"),
            "kfc": ("è‚¯å¾·åŸº KFCï¼šæ¿€çœå„ªæƒ ä»£ç¢¼å¤§å…¨", "ç¾é£Ÿé¡", "ğŸ— æ¿€çœ 5 æŠ˜èµ·", "è‚¯å¾·åŸºä»£ç¢¼å¤§å…¨ï¼šç‚¸é›ã€è›‹å¡”ã€å€‹äººé¤é€šé€šæœ‰å„ªæƒ ï¼Œå¯¦æ¸¬ä»£ç¢¼å¯ç”¨ã€‚", "4.5", "8è¬+ ç”¨æˆ¶æ¨è–¦"),
            "klook": ("KLOOK å®¢è·¯ï¼š2025 å…¨çƒæ™¯é»é–€ç¥¨å„ªæƒ ", "æ—…éŠé¡", "âœˆï¸ ç¾æŠ˜ $100", "KLOOK å…¨çƒæ—…éŠå„ªæƒ ç¢¼ï¼šåŒ…å«åœ‹å¤–æ™¯é»é–€ç¥¨ã€äº¤é€šç¥¨åˆ¸éš±è—æŠ˜æ‰£ã€‚", "4.8", "60è¬+ æ—…äººå¥½è©•"),
            "kkday": ("KKdayï¼šåœ‹å¤–æ—…éŠé«”é©—èˆ‡æ¥é€æŠ˜æ‰£", "æ—…éŠé¡", "âœˆï¸ æ»¿é¡æŠ˜ $100", "2025 æ—…éŠå¿…å‚™ KKDAY å„ªæƒ æ¸…å–®ï¼ŒåŒ…å«å…¨çƒä¸€æ—¥éŠé«”é©—èˆ‡æ©Ÿå ´æ¥é€æŠ˜æ‰£ã€‚", "4.7", "30è¬+ æ—…äººæ¨è–¦"),
            "shoppee": ("è¦çš®è³¼ç‰©ï¼š2025 å…é‹åˆ¸èˆ‡æŠ˜åƒ¹åˆ¸æ”»ç•¥", "è³¼ç‰©ç¶²ç«™", "ğŸ å…é‹å„ªæƒ ä¸­", "è¦çš®è³¼ç‰© 2025 å…é‹åˆ¸ã€æŠ˜åƒ¹åˆ¸é ˜å–æ”»ç•¥ã€‚åŒ…å«å•†åŸæŠ˜æ‰£ç¢¼èˆ‡é™æ™‚ç‰¹è³£è³‡è¨Šã€‚", "4.8", "250è¬+ è²·å®¶æ¨è–¦"),
            "yahoo": ("Yahoo è³¼ç‰©ä¸­å¿ƒï¼šé™æ™‚é ˜åˆ¸æŠ˜ 15% æ”»ç•¥", "è³¼ç‰©ç¶²ç«™", "ğŸ’° é ˜åˆ¸æŠ˜ 15%", "YAHOO è³¼ç‰©ä¸­å¿ƒé ˜åˆ¸æ•™å­¸ï¼šéš±è—ç‰ˆ 15% å›é¥‹é ˜å–æµç¨‹å¯¦æ¸¬ã€‚", "4.4", "15è¬+ æœƒå“¡è©•é‘‘"),
            "carrefour": ("å®¶æ¨‚ç¦ç·šä¸Šè³¼ç‰©ï¼šç•¶æ—¥é…å…æ’éšŠå„ªæƒ ", "è³¼ç‰©ç¶²ç«™", "ğŸ›’ æ»¿é¡æŠ˜ $100", "å®¶æ¨‚ç¦ç·šä¸Šè³¼ç‰©å…æ’éšŠï¼è¼¸å…¥æŠ˜æ‰£ç¢¼ç¾æŠ˜ $100ï¼Œç•¶æ—¥é…é€è¶…æ–¹ä¾¿ã€‚", "4.2", "5è¬+ ç”¨æˆ¶å¥½è©•"),
            "agoda": ("Agoda è¨‚æˆ¿ç‰¹æƒ ï¼šå…¨çƒä½å®¿ 9 æŠ˜æŠ˜æ‰£ç¢¼", "æ—…éŠé¡", "ğŸ¨ è¨‚æˆ¿ 9 æŠ˜èµ·", "Agoda å…¨çƒè¨‚æˆ¿å„ªæƒ ï¼šéš±è—ç‰ˆç‰¹æƒ æŠ˜æ‰£ç¢¼ï¼Œå¯¦æ¸¬åœ‹å…§å¤–ä½å®¿çš†é©ç”¨ã€‚", "4.6", "200è¬+ æ—…äººå¥½è©•")
        }

        for index, row in df.iterrows():
            # ä½¿ç”¨ filename ä¾†åˆ¤æ–·å“ç‰Œ
            filename = str(row.get('filename', '')).lower()
            current_tags = str(row.get('tags', ''))
            
            for key, val in kb.items():
                if key in filename:
                    # 1. å¼·åˆ¶é‡å¯«æ¨™é¡Œ (Title)
                    df.at[index, 'title'] = val[0]
                    
                    # 2. æ ¡æº– Tags: ç¢ºä¿åˆ†é¡åœ¨æœ€å‰é¢
                    category = val[1]
                    if category not in current_tags:
                        clean_tags = current_tags.replace('nan', '').strip()
                        new_tags = f"{category}, {clean_tags}".strip(', ')
                        df.at[index, 'tags'] = new_tags
                    
                    # 3. è£œå…¨å…¶é¤˜ç©ºç™½æ¬„ä½
                    mapping = {'price': val[2], 'summary': val[3], 'rating': val[4], 'badge': val[5]}
                    for col, value in mapping.items():
                        if pd.isna(df.at[index, col]) or str(df.at[index, col]).strip() in ['', 'nan']:
                            df.at[index, col] = value
                    break

        # æ¸…é™¤æ‰€æœ‰å¯èƒ½çš„ 'nan' å­—ä¸²
        df = df.replace('nan', '', regex=True)
        
        # å„²å­˜å› CSV
        df.to_csv(file_path, index=False, encoding='utf-8-sig')
        print("âœ¨ [å…¨æ–¹ä½æ›´æ–°å®Œæˆ] Titleã€Tags èˆ‡å…§å®¹å·²åŒæ­¥æ ¡æº–ï¼")
        
    except Exception as e:
        print(f"âŒ éŒ¯èª¤: {e}")

if __name__ == "__main__":
    ultimate_sync()